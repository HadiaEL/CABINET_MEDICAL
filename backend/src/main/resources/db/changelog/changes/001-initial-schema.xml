<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

    <changeSet id="001-create-specialites-table" author="cabinet-medical">
        <comment>Création de la table des spécialités médicales</comment>

        <createTable tableName="specialites">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="nom" type="VARCHAR(100)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="description" type="VARCHAR(500)"/>
            <column name="created_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP"/>
        </createTable>

        <createIndex tableName="specialites" indexName="idx_specialites_nom">
            <column name="nom"/>
        </createIndex>
    </changeSet>

    <changeSet id="002-create-medecins-table" author="cabinet-medical">
        <comment>Création de la table des médecins</comment>

        <createTable tableName="medecins">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="nom" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="prenom" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="email" type="VARCHAR(255)">
                <constraints unique="true"/>
            </column>
            <column name="telephone" type="VARCHAR(20)"/>
            <column name="numero_ordre" type="VARCHAR(50)">
                <constraints unique="true"/>
            </column>
            <column name="specialite_id" type="BIGINT">
                <constraints nullable="false"
                             foreignKeyName="fk_medecin_specialite"
                             references="specialites(id)"/>
            </column>
            <column name="created_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP"/>
        </createTable>

        <createIndex tableName="medecins" indexName="idx_medecins_nom">
            <column name="nom"/>
            <column name="prenom"/>
        </createIndex>

        <createIndex tableName="medecins" indexName="idx_medecins_specialite">
            <column name="specialite_id"/>
        </createIndex>
    </changeSet>

    <changeSet id="003-create-patients-table" author="cabinet-medical">
        <comment>Création de la table des patients</comment>

        <createTable tableName="patients">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="nom" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="prenom" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="email" type="VARCHAR(255)">
                <constraints unique="true"/>
            </column>
            <column name="telephone" type="VARCHAR(20)"/>
            <column name="date_naissance" type="TIMESTAMP"/>
            <column name="adresse" type="VARCHAR(500)"/>
            <column name="created_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP"/>
        </createTable>

        <createIndex tableName="patients" indexName="idx_patients_nom">
            <column name="nom"/>
            <column name="prenom"/>
        </createIndex>
    </changeSet>

    <changeSet id="004-create-jours-semaine-table" author="cabinet-medical">
        <comment>Création de la table des jours de la semaine (pour les disponibilités)</comment>

        <createTable tableName="jours_semaine">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="nom" type="VARCHAR(20)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="numero_jour" type="INTEGER">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="ouvrable" type="BOOLEAN" defaultValueBoolean="true">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP"/>
        </createTable>

        <createIndex tableName="jours_semaine" indexName="idx_jours_numero">
            <column name="numero_jour"/>
        </createIndex>
    </changeSet>

    <changeSet id="005-create-heures-jour-table" author="cabinet-medical">
        <comment>Création de la table des heures de la journée (pour les disponibilités)</comment>

        <createTable tableName="heures_jour">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="heure" type="TIME">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="libelle" type="VARCHAR(50)"/>
            <column name="created_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP"/>
        </createTable>

        <createIndex tableName="heures_jour" indexName="idx_heures">
            <column name="heure"/>
        </createIndex>
    </changeSet>

    <changeSet id="006-create-disponibilites-medecin-table" author="cabinet-medical">
        <comment>Création de la table des disponibilités des médecins (horaires de travail)</comment>

        <createTable tableName="disponibilites_medecin">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="medecin_id" type="BIGINT">
                <constraints nullable="false"
                             foreignKeyName="fk_dispo_medecin"
                             references="medecins(id)"/>
            </column>
            <column name="jour_semaine_id" type="BIGINT">
                <constraints nullable="false"
                             foreignKeyName="fk_dispo_jour"
                             references="jours_semaine(id)"/>
            </column>
            <column name="heure_debut_id" type="BIGINT">
                <constraints nullable="false"
                             foreignKeyName="fk_dispo_heure_debut"
                             references="heures_jour(id)"/>
            </column>
            <column name="heure_fin_id" type="BIGINT">
                <constraints nullable="false"
                             foreignKeyName="fk_dispo_heure_fin"
                             references="heures_jour(id)"/>
            </column>
            <column name="actif" type="BOOLEAN" defaultValueBoolean="true">
                <constraints nullable="false"/>
            </column>
            <column name="note" type="VARCHAR(500)"/>
            <column name="created_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP"/>
        </createTable>

        <addUniqueConstraint
            tableName="disponibilites_medecin"
            columnNames="medecin_id, jour_semaine_id, heure_debut_id"
            constraintName="uk_medecin_jour_heure"/>

        <createIndex tableName="disponibilites_medecin" indexName="idx_medecin_jour">
            <column name="medecin_id"/>
            <column name="jour_semaine_id"/>
        </createIndex>
    </changeSet>

    <changeSet id="007-create-rendez-vous-table" author="cabinet-medical">
        <comment>Création de la table des rendez-vous avec date/heure complètes</comment>

        <createTable tableName="rendez_vous">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="patient_id" type="BIGINT">
                <constraints nullable="false"
                             foreignKeyName="fk_rdv_patient"
                             references="patients(id)"/>
            </column>
            <column name="medecin_id" type="BIGINT">
                <constraints nullable="false"
                             foreignKeyName="fk_rdv_medecin"
                             references="medecins(id)"/>
            </column>
            <column name="date_heure_debut" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="date_heure_fin" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="statut" type="VARCHAR(20)" defaultValue="CONFIRME">
                <constraints nullable="false"/>
            </column>
            <column name="motif" type="VARCHAR(1000)"/>
            <column name="notes" type="VARCHAR(2000)"/>
            <column name="created_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP"/>
        </createTable>

        <addUniqueConstraint
            tableName="rendez_vous"
            columnNames="medecin_id, date_heure_debut"
            constraintName="uk_medecin_date_heure"/>

        <createIndex tableName="rendez_vous" indexName="idx_patient_date">
            <column name="patient_id"/>
            <column name="date_heure_debut"/>
        </createIndex>

        <createIndex tableName="rendez_vous" indexName="idx_medecin_date">
            <column name="medecin_id"/>
            <column name="date_heure_debut"/>
        </createIndex>

        <createIndex tableName="rendez_vous" indexName="idx_statut">
            <column name="statut"/>
        </createIndex>
    </changeSet>

</databaseChangeLog>

